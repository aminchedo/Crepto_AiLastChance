# Crepto AI Alert Rules
groups:
  # === API Health Alerts ===
  - name: api_health
    interval: 30s
    rules:
      # Backend API Down
      - alert: BackendAPIDown
        expr: up{job="backend-api"} == 0
        for: 1m
        labels:
          severity: critical
          service: backend
        annotations:
          summary: "Backend API is down"
          description: "Backend API ({{ $labels.instance }}) has been down for more than 1 minute"

      # Proxy Server Down
      - alert: ProxyServerDown
        expr: up{job="proxy-server"} == 0
        for: 1m
        labels:
          severity: critical
          service: proxy
        annotations:
          summary: "Proxy Server is down"
          description: "Proxy Server ({{ $labels.instance }}) has been down for more than 1 minute"

      # Frontend Down
      - alert: FrontendDown
        expr: up{job="frontend"} == 0
        for: 2m
        labels:
          severity: warning
          service: frontend
        annotations:
          summary: "Frontend is down"
          description: "Frontend ({{ $labels.instance }}) has been down for more than 2 minutes"

  # === Performance Alerts ===
  - name: performance
    interval: 30s
    rules:
      # High CPU Usage
      - alert: HighCPUUsage
        expr: |
          100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is above 80% for more than 5 minutes on {{ $labels.instance }}"

      # High Memory Usage
      - alert: HighMemoryUsage
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is above 85% on {{ $labels.instance }}"

      # High Disk Usage
      - alert: HighDiskUsage
        expr: |
          (1 - (node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes{fstype!="tmpfs"})) * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High disk usage detected"
          description: "Disk usage is above 85% on {{ $labels.instance }} at {{ $labels.mountpoint }}"

  # === API Response Time Alerts ===
  - name: api_latency
    interval: 1m
    rules:
      # Slow API Responses
      - alert: SlowAPIResponses
        expr: |
          histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "API response time is slow"
          description: "95th percentile of API response time is above 2 seconds"

  # === Error Rate Alerts ===
  - name: error_rates
    interval: 1m
    rules:
      # High Error Rate
      - alert: HighErrorRate
        expr: |
          (sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))) * 100 > 5
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate is above 5% for the last 5 minutes"

      # API Failures
      - alert: APIFailures
        expr: |
          rate(http_requests_total{status=~"5.."}[5m]) > 10
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High number of API failures"
          description: "More than 10 failed requests per second"

  # === Container Alerts ===
  - name: containers
    interval: 30s
    rules:
      # Container Restarting
      - alert: ContainerRestarting
        expr: |
          rate(container_last_seen{name!=""}[5m]) > 0.01
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Container is restarting"
          description: "Container {{ $labels.name }} has been restarting frequently"

      # High Container Memory Usage
      - alert: ContainerHighMemory
        expr: |
          (container_memory_usage_bytes / container_spec_memory_limit_bytes) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Container memory usage is high"
          description: "Container {{ $labels.name }} is using more than 80% of its memory limit"

  # === External API Alerts ===
  - name: external_apis
    interval: 1m
    rules:
      # CoinMarketCap API Failures
      - alert: CoinMarketCapFailures
        expr: |
          rate(proxy_api_requests_total{api="coinmarketcap",status="error"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          api: coinmarketcap
        annotations:
          summary: "CoinMarketCap API is failing"
          description: "CoinMarketCap API failure rate is high"

      # News API Failures  
      - alert: NewsAPIFailures
        expr: |
          rate(proxy_api_requests_total{api="newsapi",status="error"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          api: newsapi
        annotations:
          summary: "News API is failing"
          description: "News API failure rate is high"

  # === Database Alerts ===
  - name: database
    interval: 30s
    rules:
      # Database Connection Pool Exhausted
      - alert: DatabasePoolExhausted
        expr: |
          database_connections_active / database_connections_max > 0.9
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Database connection pool nearly exhausted"
          description: "Database connection pool is at {{ $value | humanizePercentage }} capacity"
